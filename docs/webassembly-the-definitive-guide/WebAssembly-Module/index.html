<!doctype html>
<html class="docs-version-current" lang="zh-cn" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Gx&#39;sBlog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Gx&#39;sBlog Atom Feed"><title data-react-helmet="true">第三章、WebAssembly Module | Gx&#x27;sBlog</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://gouxin.fun/docs/webassembly-the-definitive-guide/WebAssembly-Module"><meta data-react-helmet="true" name="docusaurus_locale" content="zh-cn"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="第三章、WebAssembly Module | Gx&#x27;sBlog"><meta data-react-helmet="true" name="description" content="webassembly中的Module结构"><meta data-react-helmet="true" property="og:description" content="webassembly中的Module结构"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://gouxin.fun/docs/webassembly-the-definitive-guide/WebAssembly-Module"><link data-react-helmet="true" rel="alternate" href="https://gouxin.fun/docs/webassembly-the-definitive-guide/WebAssembly-Module" hreflang="zh-cn"><link data-react-helmet="true" rel="alternate" href="https://gouxin.fun/docs/webassembly-the-definitive-guide/WebAssembly-Module" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.0efb2d18.css">
<link rel="preload" href="/assets/js/runtime~main.c1288573.js" as="script">
<link rel="preload" href="/assets/js/main.6eaf9a4d.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/avator.jpg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/avator.jpg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">我的Blog</b></a><a class="navbar__item navbar__link" href="/">近期文章</a><a class="navbar__item navbar__link" href="/archive">日期归档</a><a class="navbar__item navbar__link" href="/tags">所有标签</a><a class="navbar__item navbar__link" href="/reading">书籍阅读</a><a class="navbar__item navbar__link" href="/aboutme">关于我</a></div><div class="navbar__items navbar__items--right"><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">🌜</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">🌞</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_35hR" type="button"></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/webassembly-the-definitive-guide/关于本书">关于本书</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/webassembly-the-definitive-guide/简介">第一章、简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/webassembly-the-definitive-guide/hello-world">第二章、hello world</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs/webassembly-the-definitive-guide/WebAssembly-Module">第三章、WebAssembly Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/webassembly-the-definitive-guide/使用C:C++和WebAssembly">第五章、使用C/C++和WebAssembly</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>第三章、WebAssembly Module</h1></header><p>操作系统运行的程序通常都是编译后的格式。每个操作系统都有自己的格式，它定义了从哪里开始、哪些数据是必需的，以及针对不同函数的指令是什么。</p><p>WebAssembly 也是一样的。</p><p>在本章中，我们将查看它是如何打包的，以及主机如何知道怎么处理它。</p><p>软件工程师可能会在整个职业生涯中忽略程序在是如何加载和执行的。他们的世界都是从main函数开始和结束的，<code>int main(int argc, char **argv)</code>或<code>static void main(String []args)</code>甚至<code>if __name__ == &quot;__main__&quot;:</code>，这些是众所周知的 C、Java 和 Python 程序的入口点，因此这是程序员承担控制流责任的地方。然而，在程序启动之前和退出之后，操作系统或程序运行时需要设置和销毁可执行结构。加载器进程需要知道指令从哪里开始、数据元素如何初始化、需要加载哪些其他模块或库等等。</p><p>这些细节通常由可执行文件的性质决定。在 Linux 上，这是由 Executable and Linkable Format (ELF)  定义的，在 Windows 上，它是 Portable Executable (PE) 格式，在 macOS 上，它是 Mach-O 格式。这些显然是特定于平台的格式。更加可移植的系统，如 Java 和 .NET 使用中间字节码表示，但仍然有一个定义好的结构，它们用于类似的目的。</p><p>WebAssembly MVP 的主要设计考虑之一是定义模块结构，以便 WebAssembly 主机知道在执行部署单元时要查找和验证什么以及从哪里开始。</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="模块结构">模块结构<a aria-hidden="true" class="hash-link" href="#模块结构" title="Direct link to heading">​</a></h2><p>最基本的 WebAssembly 模块是一个空模块。</p><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">例 3-1。一个空的但有效的 WebAssembly 模块</div><div class="codeBlockContent_hGly wat"><pre tabindex="0" class="prism-code language-wat codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">(module)</span><br></span></code></pre><button type="button" aria-label="拷贝code到剪切板" class="copyButton_Ue-o clean-btn">复制</button></div></div><p>显然看的不多，但是可以转换成二进制形式。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">brian@tweezer ~/g/w/s/ch0</span><span class="token operator file-descriptor important" style="color:#393A34">3</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> wat2wasm empty.wat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">brian@tweezer ~/g/w/s/ch0</span><span class="token operator file-descriptor important" style="color:#393A34">3</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -alF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total </span><span class="token number" style="color:#36acaa">16</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x  </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> brian  staff  </span><span class="token number" style="color:#36acaa">128</span><span class="token plain"> Dec </span><span class="token number" style="color:#36acaa">21</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:45 ./</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x  </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> brian  staff  </span><span class="token number" style="color:#36acaa">128</span><span class="token plain"> Dec </span><span class="token number" style="color:#36acaa">14</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:37 </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--  </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> brian  staff    </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> Dec </span><span class="token number" style="color:#36acaa">21</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:45 empty.wasm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--  </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> brian  staff    </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> Dec </span><span class="token number" style="color:#36acaa">14</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:37 empty.wat</span><br></span></code></pre><button type="button" aria-label="拷贝code到剪切板" class="copyButton_Ue-o clean-btn">复制</button></div></div><p>操作系统通常从文件的前几个字节中识别文件格式。它们通常被称为<code>magic number</code>。对于 WebAssembly，字节被<em>\0asm</em>编码为<code>0x00 0x61 0x73 0x6D</code>表示字符<em>a</em>、<em>s</em>和<em>m 的</em>十六进制值 。后面跟着版本号 1（由 bytes 表示<code>0x01 0x00 0x00 0x00</code>）。</p><p>对于查看Module的命令行，你可以有多种选择，但是推荐 Wabt 工具包中的 wasm-objdump 。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">brian@tweezer ~/g/w/s/ch0</span><span class="token operator file-descriptor important" style="color:#393A34">3</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> wasm-objdump -x empty.wasm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">empty.wasm: </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">format</span><span class="token plain"> wasm 0x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Section Details:</span><br></span></code></pre><button type="button" aria-label="拷贝code到剪切板" class="copyButton_Ue-o clean-btn">复制</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="探索module-section">探索Module section<a aria-hidden="true" class="hash-link" href="#探索module-section" title="Direct link to heading">​</a></h2><p>下面是Module section列表：</p><table><thead><tr><th align="left">Id</th><th align="left">Name</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left">0</td><td align="left">Custom</td><td align="left">供第三方使用的调试或元数据信息</td></tr><tr><td align="left">1</td><td align="left">Type</td><td align="left">模块中使用的Type definitions</td></tr><tr><td align="left">2</td><td align="left">Import</td><td align="left">模块使用的导入元素</td></tr><tr><td align="left">3</td><td align="left">Function</td><td align="left">与模块中的函数关联的类型签名</td></tr><tr><td align="left">4</td><td align="left">Table</td><td align="left">定义模块使用的间接、不可变引用的表</td></tr><tr><td align="left">5</td><td align="left">Memory</td><td align="left">模块使用的线性内存结构</td></tr><tr><td align="left">6</td><td align="left">Global</td><td align="left">全局变量</td></tr><tr><td align="left">7</td><td align="left">Export</td><td align="left">模块提供的导出元素</td></tr><tr><td align="left">8</td><td align="left">Start</td><td align="left">可选的用于初始化Module的start函数</td></tr><tr><td align="left">9</td><td align="left">Element</td><td align="left">由模块定义的元素</td></tr><tr><td align="left">10</td><td align="left">Code</td><td align="left">模块定义的函数体</td></tr><tr><td align="left">11</td><td align="left">Data</td><td align="left">模块定义的数据元素</td></tr><tr><td align="left">12</td><td align="left">Data Count</td><td align="left">模块定义的数据元素的数量</td></tr></tbody></table><p>这是我们之前的例子：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly wat"><pre tabindex="0" class="prism-code language-wat codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">(module</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (func $how_old (param $year_now i32) (param $year_born i32) (result i32) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        get_local $year_now</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        get_local $year_born</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        i32.sub)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (export &quot;how_old&quot; (func $how_old)) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span></code></pre><button type="button" aria-label="拷贝code到剪切板" class="copyButton_Ue-o clean-btn">复制</button></div></div><p>我们现在使用<code>wat2wasm</code>将其转化为二进制形式。然后使用<code>wasm-objdump</code>查看详细信息。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">brian@tweezer ~/g/w/s/ch0</span><span class="token operator file-descriptor important" style="color:#393A34">3</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> wasm-objdump -x hello.wasm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello.wasm: </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">format</span><span class="token plain"> wasm 0x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Section Details:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - type</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i32, i32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> i32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Function</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - func</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">sig</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">how_old</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Export</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - func</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">how_old</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;how_old&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Code</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - func</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">how_old</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><button type="button" aria-label="拷贝code到剪切板" class="copyButton_Ue-o clean-btn">复制</button></div></div><p>与我们的空模块相比，多了很多的section。首先，我们有一个<code>Type</code>定义了一个签名。它表示类型：有两个<code>i32</code>参数，返回一个<code>i32</code>类型。这是我们<code>how_old</code> 函数的签名。</p><p>接下来，我们有一个<code>Function</code>部分。将我们的类型（来自<code>Type</code>部分的类型 0 ）链接到一个命名函数。</p><p>因为我们导出我们的函数以使其可用于我们的主机环境或其他模块，所以我们看到内部函数<code>&lt;how_old&gt;</code>是通过 name 导出的 <code>&quot;how_old&quot;</code>。最后，我们有一个<code>Code</code>部分包含我们唯一函数的实际指令。</p><p>我们来看看他在<a href="https://wasdk.github.io/wasmcodeexplorer/" target="_blank" rel="noopener noreferrer">wasm code explor</a>中的样子。</p><p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gw5oodlbafj31p20cewgf.jpg" alt="image-20211106200449169"></p><p>其中红色代表的是section边界， 你也可以悬停鼠标到某个颜色上，这会显示其详细信息。</p><p>你可能注意到了，我们的变量名似乎没有出现。为了调试，你需要在<code> wat2wasm</code>命令中指定<code>--debug-names</code>。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">brian@tweezer ~/g/w/s/ch0</span><span class="token operator file-descriptor important" style="color:#393A34">3</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> wat2wasm hello.wat -o hellodebug.wasm --debug-names</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">brian@tweezer ~/g/w/s/ch0</span><span class="token operator file-descriptor important" style="color:#393A34">3</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> wasm-objdump -x hellodebug.wasm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hellodebug.wasm:    </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">format</span><span class="token plain"> wasm 0x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Section Details:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - type</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i32, i32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> i32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Function</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - func</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">sig</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">how_old</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Export</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - func</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">how_old</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;how_old&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Code</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - func</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">how_old</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Custom:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - name: </span><span class="token string" style="color:#e3116c">&quot;name&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - func</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">how_old</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - func</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">year_now</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - func</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">year_born</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><button type="button" aria-label="拷贝code到剪切板" class="copyButton_Ue-o clean-btn">复制</button></div></div><p>我们看到<code>wat2wasm </code>使用<code>Custom </code>section来保留函数和局部变量的详细信息。</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="使用模块">使用模块<a aria-hidden="true" class="hash-link" href="#使用模块" title="Direct link to heading">​</a></h2><p>之前的代码中生成了一个<code>Export</code>部分，但正如我们在<code>Module section</code>列表看到的那样，还有一个<code>Import</code>部分用于从主机环境接收元素。</p><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">例 3-3</div><div class="codeBlockContent_hGly wat"><pre tabindex="0" class="prism-code language-wat codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">(module</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (func $log (import &quot;imports&quot; &quot;log_func&quot;) (param i32)) ;;导入函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (func $how_old (param $year_now i32) (param $year_born i32) (result i32) ;;内部函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        get_local $year_now</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        get_local $year_born</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        i32.sub)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (func $log_how_old (param $year_now i32) (param $year_born i32) ;;调用了导入函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        get_local $year_now</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                get_local $year_born</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                call $how_old</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            call $log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (export &quot;how_old&quot; (func $how_old)) ;;导出函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (export &quot;log_how_old&quot; (func $log_how_old)) ;;导出函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span></code></pre><button type="button" aria-label="拷贝code到剪切板" class="copyButton_Ue-o clean-btn">复制</button></div></div><p>现在让我们生成<em>.wasm</em>， 看看他的模块结构:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">brian@tweezer ~/g/w/s/ch0</span><span class="token operator file-descriptor important" style="color:#393A34">3</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> wat2wasm hellolog.wat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">brian@tweezer ~/g/w/s/ch0</span><span class="token operator file-descriptor important" style="color:#393A34">3</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> wasm-objdump -x hellolog.wasm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hellolog.wasm:  </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">format</span><span class="token plain"> wasm 0x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Section Details:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - type</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - type</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i32, i32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> i32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - type</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i32, i32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Import</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - func</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">sig</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">imports.log_func</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">- imports.log_func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Function</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - func</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">sig</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">how_old</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - func</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">sig</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">log_how_old</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Export</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - func</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">how_old</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;how_old&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - func</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">log_how_old</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;log_how_old&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Code</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - func</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">how_old</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - func</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">log_how_old</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><button type="button" aria-label="拷贝code到剪切板" class="copyButton_Ue-o clean-btn">复制</button></div></div><p>我们第一次看到<code>Import</code> section。它被定义为具有我们尚未见过的类型。如果您查看该<code>Type</code> 部分，您将看到我们现在指定了三种类型。</p><p>第一个类型是定义在我们的Import中。我们期望主机环境给我们提供一个带i32参数的函数。这个函数的目的是以某种方式打印我们的参数。我们期望从之前在 JavaScript 端中定义的<code>importObject</code>中找到这个函数。</p><p>为了通过 提供<code>importObject</code>我们需要一些类似于<code>示例 3-4</code>所示的 HTML 代码：</p><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">例 3-4。使用 importObject实例化我们的模块</div><div class="codeBlockContent_hGly html"><pre tabindex="0" class="prism-code language-html codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token doctype punctuation" style="color:#393A34;font-style:italic">&lt;!</span><span class="token doctype doctype-tag" style="color:#999988;font-style:italic">DOCTYPE</span><span class="token doctype" style="color:#999988;font-style:italic"> </span><span class="token doctype name" style="color:#999988;font-style:italic">html</span><span class="token doctype punctuation" style="color:#393A34;font-style:italic">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">html</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">lang</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">en</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">head</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">meta</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">charset</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">UTF-8</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">meta</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">http-equiv</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">X-UA-Compatible</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">content</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">IE=edge</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">meta</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">viewport</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">content</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">width=device-width, initial-scale=1.0</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">title</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">Document</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">title</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">head</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">body</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">        </span><span class="token script language-javascript keyword" style="color:#00009f">function</span><span class="token script language-javascript"> </span><span class="token script language-javascript function" style="color:#d73a49">fetchAndInstantiate</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript parameter">url</span><span class="token script language-javascript parameter punctuation" style="color:#393A34">,</span><span class="token script language-javascript parameter"> importObject</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">            </span><span class="token script language-javascript keyword control-flow" style="color:#00009f">return</span><span class="token script language-javascript"> </span><span class="token script language-javascript function" style="color:#d73a49">fetch</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript">url</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">            </span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">then</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript parameter">response</span><span class="token script language-javascript"> </span><span class="token script language-javascript arrow operator" style="color:#393A34">=&gt;</span><span class="token script language-javascript"> response</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">arrayBuffer</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">            </span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">then</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript parameter">bytes</span><span class="token script language-javascript"> </span><span class="token script language-javascript arrow operator" style="color:#393A34">=&gt;</span><span class="token script language-javascript"> </span><span class="token script language-javascript known-class-name class-name">WebAssembly</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">instantiate</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript">bytes</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"> importObject</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">            </span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">then</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript parameter">result</span><span class="token script language-javascript"> </span><span class="token script language-javascript arrow operator" style="color:#393A34">=&gt;</span><span class="token script language-javascript"> result</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">instance</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">        </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">        </span><span class="token script language-javascript keyword" style="color:#00009f">const</span><span class="token script language-javascript"> importObject </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">            imports</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">                </span><span class="token script language-javascript function-variable function" style="color:#d73a49">log_func</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript keyword" style="color:#00009f">function</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript parameter">arg</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">                    </span><span class="token script language-javascript console class-name">console</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">log</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript template-string template-punctuation string" style="color:#e3116c">`</span><span class="token script language-javascript template-string string" style="color:#e3116c">you are </span><span class="token script language-javascript template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token script language-javascript template-string interpolation">arg</span><span class="token script language-javascript template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token script language-javascript template-string string" style="color:#e3116c"> years old</span><span class="token script language-javascript template-string template-punctuation string" style="color:#e3116c">`</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">                </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">            </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">        </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">        </span><span class="token script language-javascript function" style="color:#d73a49">fetchAndInstantiate</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&quot;./aaa.wasm&quot;</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"> importObject</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">        </span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">then</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript parameter">instance</span><span class="token script language-javascript"> </span><span class="token script language-javascript arrow operator" style="color:#393A34">=&gt;</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">            instance</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">exports</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">log_how_old</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript number" style="color:#36acaa">2021</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"> </span><span class="token script language-javascript number" style="color:#36acaa">2010</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">        </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">body</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">html</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><button type="button" aria-label="拷贝code到剪切板" class="copyButton_Ue-o clean-btn">复制</button></div></div><p>我们将<code>importObject</code>和<code>例3-3</code>中定义的import section做个比较。我们注意到import section中指定了一个命名空间为<code>imports</code>的叫做<code>log_func</code>的函数。而这正是我们<code>importObject</code>决定的。</p><p>我们再来看看<code>log_how_old</code>函数，他接受2个参数，调用<code>get_local</code>检索命名参数将其压入栈顶。然后用<code>call $how_old</code>指令调用我们之前的函数。该函数从另一个参数中减去一个参数，然后在堆栈顶部返回结果。此时，我们不必将该值重新推送到堆栈中，我们可以简单地调用我们命名为  <code>$log</code>的导入函数。前一个函数的结果将是这次新调用的参数。花点时间确保您了解参数、返回值和函数之间的关系。</p><p>我们还可以使用javascript API来查询import和export了哪些方法：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token known-class-name class-name">WebAssembly</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">compileStreaming</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;./aaa.wasm&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">module</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> imports </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token known-class-name class-name">WebAssembly</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access maybe-class-name">Module</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">imports</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">module</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">imports</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> exports </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token known-class-name class-name">WebAssembly</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access maybe-class-name">Module</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">exports</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">module</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exports</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="拷贝code到剪切板" class="copyButton_Ue-o clean-btn">复制</button></div></div><p>最后，再让我们回顾一下<code>fetchAndInstantiate</code>函数，对于简单的模块，这很好，但是你的模块越大，有一些内置的延迟是可以消除的。性能不仅与运行时性能有关，还与加载时性能有关。</p><p>对于<code>fetchAndInstantiate</code>函数，即使我们使用 Promise 来避免阻塞主线程，我们还是先将模块读入一个 <code>ArrayBuffer</code>然后实例化它。在编译模块之前，我们实际上是在等待所有网络传输完成。</p><p>MVP 功能之一就是在字节通过网络拉取时支持编译的能力。</p><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">例 3-8。大多数时间实例化模块的推荐方法</div><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> fetchPromise </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> instance </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token known-class-name class-name">WebAssembly</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">instantiateStreaming</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fetchPromise</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Use the module</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> instance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">exports</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">method</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">param1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> param2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="拷贝code到剪切板" class="copyButton_Ue-o clean-btn">复制</button></div></div><p>请注意，上面我们不是在创建<code>ArrayBuffer</code>，而是将<code>Promise</code>传入WebAssembly的`instantiateStreaming()方法中。这允许编译器在函数出现在网络上时开始编译它们。在大多数情况下，代码编译会比网络传输更快，因此在您完成下载代码时，它应该已经通过验证并可以使用。当 JavaScript 完成下载时，通常是在验证过程开始时，因此我们看到启动时间有所改善。</p><p>目前还没有一种正式的方法来缓存 WebAssembly 模块，但这其实也是提高启动时间的一种不显眼的方式。</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="未来-es6-module集成">未来 ES6 Module集成<a aria-hidden="true" class="hash-link" href="#未来-es6-module集成" title="Direct link to heading">​</a></h2><p>正如我们所见，虽然我们能通过 JavaScript API 来加载wasm，但它是低级和重复的，这就是我们将它封装成一个函数的原因。未来，我们希望从 HTML 中使用 WebAssembly 模块会更容易，因为它们将作为 ES6 模块提供。</p><p>目前已有相关提案。到时候我们就可以这么使用：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#393A34">{</span><span class="token imports">something</span><span class="token imports punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;./myModule.wasm&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">something</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="拷贝code到剪切板" class="copyButton_Ue-o clean-btn">复制</button></div></div><p>现在我们已经了解了 WebAssembly 二进制文件的结构，您应该可以轻松地查看一下自己的或第三方的模块。下一步是查看 WebAssembly 模块中更动态的元素，我们将首先关注<code>Memory</code>。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>标签</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/docs/tags/web-assembly">WebAssembly</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/docs/tags/module">Module</a></li></ul></div></div><section></section></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/webassembly-the-definitive-guide/hello-world"><div class="pagination-nav__sublabel">上一篇</div><div class="pagination-nav__label">« <!-- -->第二章、hello world</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/webassembly-the-definitive-guide/使用C:C++和WebAssembly"><div class="pagination-nav__sublabel">下一篇</div><div class="pagination-nav__label">第五章、使用C/C++和WebAssembly<!-- --> »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#模块结构" class="table-of-contents__link toc-highlight">模块结构</a></li><li><a href="#探索module-section" class="table-of-contents__link toc-highlight">探索Module section</a></li><li><a href="#使用模块" class="table-of-contents__link toc-highlight">使用模块</a></li><li><a href="#未来-es6-module集成" class="table-of-contents__link toc-highlight">未来 ES6 Module集成</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.c1288573.js"></script>
<script src="/assets/js/main.6eaf9a4d.js"></script>
</body>
</html>