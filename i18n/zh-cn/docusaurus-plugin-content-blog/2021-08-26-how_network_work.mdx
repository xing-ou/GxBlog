---
title: 网络是怎样工作的?
description: 有些人认为Internet是许多连接在一起的设备组成的网络。这个理解有点问题，因为在Internet上很少有设备直接连接在一起。
date: "2021-07-24"
---

## How is The Internet work?

有些人认为Internet是许多连接在一起的设备组成的网络。这个理解有点问题，因为在Internet上很少有设备直接连接在一起。

Internet是去中心话的网络。

![image-20210729161808177](https://tva1.sinaimg.cn/large/008i3skNgy1gsxw5nx4lrj309u07yq2t.jpg)

### Node and Network

Node是网络上可以接收和发送信息的设备，比如：笔记本电脑，服务器等。在Network上，每一个Node都有一个address，node通过address找到另一个node。事实上任何一个拥有network address的都是一个Node。在internet上network address就是IP address。

我们通过路由器来连接不同的网络，路由器是分发IP packet的设备。

### Hardware Address

一个电子设备通常由电源，声卡，显卡，处理器，摄像头，麦克风等构成。对于网络，我们只要关注网卡。

网卡处理device到network的连接，包括向network提供设备的identification。

#### Media Access Control Address(MAC)

现代设备，比如手机，笔记本都有一块小的网卡，允许他们连接到internet。每个Node都需要一个网卡来接入internet，就像需要一个设备需要AM/FM来接入无线。

每个网卡都有一个MAC地址，他是设备和其他设备交流的唯一标志。

MAC地址只在local network中有用。

通常非loacl network的node会请求和保存MAC地址。

#### Random MAC Address

因为MAC地址代表了一个唯一标记，可能被滥用，以至于泄漏用户隐私。

所以现在的一些操作系统都开始将mac地址随机化，这样来阻止将MAC地址和真实世界的某些标记联系起来。

### How device becomes Part of Network

当你的设备联网时，你通常都是用网线，或者wifi连接到你的路由器。

#### Taking to the Router

当和网络上其他Node交流的时候，你除了MAC地址外，还需要一个网络地址。为了获取一个网络地址，你的设备需要和路由器交互。

当你的设备连接到路由器时，会发送一个DHCP request，路由器会为你分配一个网络地址，并告诉你将要发送到网络上的数据发送到局域网的网关(通常都是路由器自身)。

当你的网卡的MAC拥有了网络地址后，你的设备就成为了网络的一部分。

## What form does information  take on the  internet?

### Packet

两个设备间交互式通过packets进行的。

将大的数据分成多个packet进行传输。

## How do devices communicate on the internet?

### Protocol

当两个设备交互的时候，他们需要一个都能明白的语言，我们称其为Protocol。

有时候同一种交互可能使用不同的协议：

TCP: 

UDP: 

QUIC: 使用多个udp，但行为上像tcp那样更可靠，精准

### The Internet Protocol(IP)

Ip protocol定义了ip地址和ip packet的格式。

#### Public And Private Ip Address

Public: 能直接访问网络，就像ISP(网络服务提供商)为你的路由器分配的那样。

Private: 不能直接访问网络，需要通过中间者。就像连接路由器的手机一样。

#### Network Address Translation(NAT)

当一个private network通过路由器连接到internet的时候，路由器使用了一种叫NAT的技术重写了packet的address标志位。

但使用NAT的时候，路由器在内存中保存了谁发送了哪个packet。当接收到response的时候，路由器又重写了response的address tag，然后把他发送给private network中的那个设备。

#### IPV4 address

NAT只会发生在ipv4中。

ipv4的组成是：xxx.xxx.xxx.xxx。xxx是0-255.

192.168.xxx.xxx

10.xxx.xxx.xxx

172.16.xxx.xxx  - 172.31.xxx.xx

这几个是private address。

0.0.0.0 - 0.0.0.31

127.xxx.xxx.xxx是保留给路由使用

其他的都是Public adress。

#### IPV6

格式是8个16位的块组成。点隔开。

相比于IPV4， IPV6还有个优点。当连接到一个支持ipv6的路由器时，device并不是收到一个由NAT重写了的private address，而是收到一大堆的public address。这让设备能够直接对外提供服务，参与到internent中。

#### Global ip address allocation

当路由器为连接的设备分配ip地址的时候，他从一个所有可能的ipv4和ipv6 地址的unique pool中获得。这个pool由IANA管理。

IANA为全球不同网络区域划分ip地址段，于是就有了regional internet registries(RIR)。

RIR再分段，交给local internet registries(LIR)。

LIR再分段，交给internet service provider(ISP)。

ISP再为我们的路由器分配IP地址。

#### IP Routing

当路由器开始发送一个packet时，他会发送到下一个已知的路由器(这通常都是ISP的big route)。

在big route里，packet的header被读取，如果是在相同网络，那么packet被发送到目标地址。如果不是的话，那么发送给下一个已知的路由器，直到到达目标地址。

#### Internet Ip Security(IPSec)

packet会经过多个路由器。每个路由器都能对packet的内容进行读取，修改，负责等操作。

攻击者可以修改ip地址，伪装成另一台电脑。

解决ip欺诈的一个方案就是ipsec。

## How does Information travel on the internet?

### The Map of the internet

internet 是由很多个小的网络组成。小的网络叫做AS(Autonomous Systems)。他可能是：大学、ISP、电话公司等等。

我们的每个用户都属于某个AS。

#### Border Gateway Protocol(BGP)

让这种连接成为可能的是协议叫做BGP。

BGP定义了packet如何在AS间进行传输。

一个AS是由很多个设备通过路由器连接组成。进出整个AS的路由器叫做BGP Router。

#### Peering

大城市间都有高速公路，如果他们之间有差不多的居民和交通，他们可能会让高速公路免费。在Internet上也是这样的，这种协议叫做Peering。

当两个AS之间同意Peering。数据就能够从一个AS传到另一个AS，通常都是免费的。

#### Internet Exchange Points(IXP)

IXP是多个AS的物理连接。

IXP之间通常都是自动peering的。

全世界大概有1000多个IXP。

#### Transport Protocol

UDP

Tcp

QUIC

## How do people relate to information on the internet?

### Domain Name System(DNS)

IP很难记，所以通过域名映射。

en             .wikipedia         .org

subdomain  domain        top-levl-domain

subdomain: domain的拥有者能够自己创建subdomain, sub-sub-domain等等

Domain: 任何人都能够从registrar那里购买domain。registrar是ICANN授权出售域名的。购买了域名的人，我们叫他registant。

Top-level-domain: .com, .org等等都属于顶级域名。顶级域名通常都是由某个registry维护和提供服务的。

Root domain: 根域名是. ，是由ICANN维护的，他管理者所有的top-level-domain。

#### how does domain name resolve back to an IP address？

当我们在浏览器中输入某个域名的时候，浏览器向DNS服务器发起DNS请求。

默认情况是由ISP会代替客户向dns server查询域名。

当你家里的路由器为你的电脑分配ip地址的时候，他也会发回能够解析这个ip的dns server地址，有时候这个地址就是路由器自身，我们称其为Local dns resolver。

当我们输入某个域名时，先从local dns reslover查询，如果查不到，那么会从顶级的根域名dns server开始查询。

根域名返回顶级域名的dns server地址。

顶级域名返回domain的ip地址。

在向domain查询整个的ip地址。

#### Http

#### Https















